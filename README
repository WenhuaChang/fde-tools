
This is a proof of concept demonstrating how full disk encryption could
be supported by the ALP installer.

What the PoC does so far, and how to use it:

 * Get the kiwi packages from OBS project home:okir:FDE
   In particular, you need the python-kiwi package.

 * As root, run
 	./mkimage prepare
	./mkimage create
   This will use kiwi to create an OEM image

   This image will contain a LUKS encrypted system partition.
   The fallback password for the LUKS partition is "1234".
   The root password is "traum"

 * As root, run
 	./run-install
   This will start the installation workflow. Use virt-manager to
   locate the VM being installed, and connect to it.

 * You will be prompted twice for the LUKS pass phrase.

 * The system goes through firstboot and massages the LUKS
   setup. Among other things, it re-encrypts the system
   partition with a new, random key, and changes the pass
   phrase for the LUKS volume.

   When prompted for the new passphrase, use "alpisgreat".
   Typing anything else will destroy your hardware.

 * When firstboot is complete, try rebooting the machine.
   During bootup, you should see a message from grub that
   it was able to unseal the key. Booting the system
   partition should proceed without you being prompted for
   the LUKS pass phrase.

 * Voila!


Implementation notes

 * The installed system receives two partitions, one EFI partition
   and one system partition (including /boot).

 * The system partition is set up as LUKS2 volume with a randomly
   generated 128byte pass key. This should hopefully be good enough
   to counterbalance any shortcomings of PBKDF2 (which is the only
   key derivation function that grub2 currently supports)

 * The pass key is sealed using the TPM against a set of PCR values.
   Proposal is to use PCR0, 2, 4 plus PCR9.

   PCR9 contains measurements of the files that grub2 loads.

   /boot/efi/EFI/BOOT/grub.cfg needs to contain instructions
   that allow it to unseal the key and use it with LUKS.
   There is a patch set for grub2 that does this, originating
   from Microsoft.

 * When the installed system boots, grub unseals the key,
   and uses it to mount the LUKS volume and access /boot.

 * grub needs to pass the unsealed key to the kernel being
   booted.

   One approach suggested by Michael Chang is to store the key
   in a volatile UEFI variable (say, LuksRootKey) and inform
   initrd via an entry in /etc/crypttab

   To test that approach, I modified the tpm key protector
   code in grub to store the LUKS key in a volatile UEFI
   variable, which works (so from the dracut emergency prompt,
   I was able to mount the efivarfs, and the LuksRootKey-* variable
   contained the LUKS key in clear text).
   
   What I did not succeed in doing, yet, was to teach
   systemd-cryptsetup-generator how to extract the key from that
   file.

   So for the time being, the installed system contains a
   clear-text copy of a LUKS key in /.root.keyfile, which
   ends up in the initrd and is used to open the LUKS
   device.

 * IF the user boots anything other than the default kernel
   entry from grub.cfg with the default set of command line
   options, grub should NOT pass the unsealed key to the
   kernel (and it should make sure to wipe memory buffers that
   held the unsealed key - which the grub patch set currently
   is not doing).

   Alternatively, we could disallow editing in grub entirely when
   full disk encryption is in effect. If the user ever needs to
   roll back, boot a kernel in debug mode etc, they would have
   to boot through a rescue partition instead.

 * caveat: we ought to seal against PCR 9, because we need to
   detect modifications to grub.cfg in the EFI boot
   partition. However, there's currently a catch-22, because
   grub also measures the sealed key when it reads it
   from file. So in order to predict PCR 9 and seal against
   that value, we'd have to know the hash of the sealed key.
   That's chicken and egg...

   So the grub key protector stuff needs to be fixed in
   the way that we do not measure the contents of the
   sealed key file when loading it.

   [Alternatively, we could seal against PCR 8, which
   measures the grub commands being executed. But that
   is somewhat brittle in that grub doesn't measure the
   commands it reads from file, but after parsing and
   variable expansion. So when grub.cfg has a line saying
      echo "boot dev ($root)"
   grub ends up measuring something like
      echo boot dev (hd1,gpt2)
   ]

 * When sealing a secret such as the key for the LUKS
   key slot, the tpm2 tools produce a public and a
   private portion stored in separate files. The grub2
   TPM key protector patches expect the "sealed key" as a single
   file, created by concatenating the public and the private
   portion together.

 * For the time being, the PoC seals the secret against
   PCRs 0, 2, 4, and 9. grub.cfg gets modified to take
   a snapshot of PCR values and store them in an EFI
   variable that can be read later. This is required
   in order to seal against the correct PCR values.

 * Note: when sealing the key, make sure to use the exact
   same set of key attributes that the grub2 patch set
   uses to unseal it. Otherwise, you'll end up with a policy
   error, and/or decrypting garbage. See the declartion of
   TPM2_SRK_ATTRS in the build script.

 * Note: I've done some experiments with using FIDO2 tokens
   for protection. That code is nowhere near finished. Please
   see README.fido2 for some background.

TODO

 * Currently, my grub patch unconditionally adds
   tpm_record_pcrs to the generated grub.cfg file. It would be
   cleaner to introduce a command line option to grub2-install and
   make sure that our tooling adds that option.

 * Patch cryptsetup and/or systemd-cryptsetup to recognize
   EFI variables holding a LUKS key

 * Make the image building work in OBS

 * During first boot, we're being asked twice for the LUKS
   passphrase, once by grub (which is expected) and once
   by initrd (which is not).
   There's a /root.key in the initrd that should be picked up
   via crypttab...

 * When booting a grub entry other than the default, or
   when booting with modified kernel command line, grub
   should wipe the unsealed LUKS key from memory, and clear
   the EFI variable to which we exported it.

 * Bonus material: clean up the ovmf patches and find out
   why libvirt doesn't the like the OVMF bin images
   created in home:okir:FDE

DONE

 * Cleanup of grub patches (they're a mess right now)
